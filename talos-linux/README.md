# talos-linux

I chose to create patch files for Talos Linux machine configs in a function-based manner.

I may change this down the road if I start to have configuration values that end up cross-cutting functional areas, but this seemed fine for now.

## Directory layout

```sh
📂 talos-linux
├─📄 cilium-opnsense-bgp-peering-policy.patch
├─📄 disable-cni-and-kube-proxy.patch
├─📄 kubelet-unsafe-sysctls.patch
├─📄 machine-cert-sans.patch
├─📄 registry-mirrors.patch
├─📄 system-disk-encryption.patch
└─📄 talos-extension-drbd.patch
```

## Using the patches

You can apply a patch to control plane nodes, worker nodes, or both. See below for an example of all three being used together...

```shell
talosctl gen config \
  --config-patch-control-plane @talos-linux/cilium-opnsense-bgp-peering-policy.patch \
  --config-patch-worker @talos-linux/kubelet-unsafe-sysctls.patch \
  --config-patch @talos-linux/system-disk-encryption.patch \
  --config-patch='[{"op": "replace", "path": "/machine/systemDiskEncryption/ephemeral/keys", "value": [{ "static": { "passphrase": "super-secret-password" }, "slot": 0 }] }]'
```

## Patch files

### cilium-opnsense-bgp-peering-policy

Applies a label named `bgp-peering-policy` with a value of `OPNsense` to a node.

This is used to make sure that Cilium matches the node properly when reconciling `CiliumBGPPeeringPolicy/OPNsense` later on. See: `/home-ops/flux/infrastructure/config/cilium.yaml` for more details.

### disable-cni-and-kube-proxy

Tells Talos not to provision its default CNI (flannel) into the cluster; as well as preventing the installation of kube-proxy (for Cilium Agent replacement).

### kubelet-unsafe-sysctls

Allows certain unsafe sysctls to be used on a cluster node.

### registry-mirrors

Configures pull-through-caches to point to local Docker Desktop instances of Docker Registry Mirrors.

When working through an initial lab setup where you're re-building VMs over-and-over for testing purposes, this reduces your bandwidth usage drastically.

### system-disk-encryption

Configures a node to have disk encryption for the state partition, with its key generated by the node's hardware profile

Configures a node to have disk encryption for the ephemeral partition, with its key needing to be patched-in during `talosctl gen config ...`

### talos-extension-drbd

Configures kernel values required for [drbd](https://linbit.com/drbd/) to work with Talos
