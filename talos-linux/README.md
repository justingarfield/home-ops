# talos-linux

I chose to create patch files for Talos Linux machine configs in a function-based manner.

I may change this down the road if I start to have configuration values that end up cross-cutting functional areas, but this seemed fine for now.

## Directory layout

```sh
游늭 talos-linux
較럭游늯 cilium-opnsense-bgp-peering-policy.patch
較럭游늯 disable-cni-and-kube-proxy.patch
較럭游늯 disk-nvme.patch
較럭游늯 disk-nvme.patch
較럭游늯 disk-sd.patch
較럭游늯 disk-sd.patch
較럭游늯 disk-sd.patch
較럭游늯 kubelet-unsafe-sysctls.patch
較럭游늯 label-worker-node.patch
較럭游늯 machine-cert-sans.patch
較럭游늯 registry-mirrors.patch
較럭游늯 system-disk-encryption.patch
較덕游늯 talos-extension-drbd.patch
```

## Using the patches

You can apply a patch to control plane nodes, worker nodes, or both. See below for an example of all three being used together...

```shell
talosctl gen config \
  ... other args ... \
  --config-patch-control-plane @talos-linux/cilium-opnsense-bgp-peering-policy.patch \
  --config-patch-worker @talos-linux/disk-sdb.patch \
  --config-patch-worker @talos-linux/disk-sdc.patch \
  --config-patch @talos-linux/system-disk-encryption.patch
  ... other args ... \
```

## Patch files

### cilium-opnsense-bgp-peering-policy

Applies a label named `bgp-peering-policy` with a value of `OPNsense` to a node.

This is used to make sure that Cilium matches the node properly when reconciling `CiliumBGPPeeringPolicy/OPNsense` later on. See: `/home-ops/flux/infrastructure/config/cilium.yaml` for more details.

### disable-cni-and-kube-proxy

Tells Talos not to provision its default CNI (flannel) into the cluster; as well as preventing the installation of kube-proxy (for Cilium Agent replacement).

### disk-nvme*

Modifies a machine to mount `/dev/nvme0n1` or `/dev/nvme1n1` to a mount-point of `/var/mnt/nvme0n1` or `/var/mnt/nvme1n1` respectively.

### disk-sd*

Modifies a machine to mount `/dev/sdb`, `/dev/sdc`, or `/dev/sdd` to a mount-point of `/var/mnt/sdb`, `/var/mnt/sdc`, or `/var/mnt/sdd` respectively.

### kubelet-unsafe-sysctls

Allows certain unsafe sysctls to be used on a cluster node.

### label-worker-node

Applies a label named "node-role.kubernetes.io/worker" with a value of "true" to a node. It is used for worker nodes in the data plane.

This is how you can see the `worker` role when using `kubectl get nodes`; otherwise it will be blank _(which is perfectly normal too)_.

### machine-cert-sans

Adds additional certificate SANs that represent my HA Proxy endpoint used for communications via talosctl.

I also add my HA Proxy Static IP address to the ones specified in there; I do that later-on when calling "talosctl gen config ..." to create the `controlplane.yaml` and `worker.yaml` files.

### registry-mirrors



### system-disk-encryption

Configures a node to have disk encryption for the state partition, with its key generated by the node's hardware profile

Configures a node to have disk encryption for the ephemeral partition, with its key needing to be patched-in during "talosctl gen config ..."

### talos-extension-drbd (not currently in-use)

Tells Talos to install the drbd extension and configures the kernel values required for drbd to work with Talos
