---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

vars:
  TALOS_DIR: '{{ .REPOSITORY_DIR }}/talos-linux'

  # renovate: registryUrl=https://helm.cilium.io/ chart=cilium
  CILIUM_VERSION: '{{ .CILIUM_VERSION | default "v1.14.0-snapshot.3" }}'
tasks:

  status-verbose:
    desc: Uses the cilium binary in the DS for a verbose status
    cmds:
      - kubectl exec ds/cilium -n kube-system -- cilium status verbose

  get-endpoint-list:
    desc: Uses the cilium binary in the DS to query the endpoints list
    cmds:
      - kubectl -n kube-system exec ds/cilium -- cilium endpoint list

  install-via-helm:
    internal: true
    desc: Installs the Cilium CNI for a particular cluster
    vars:
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      CLUSTER_DIR: "{{.TALOS_DIR}}/{{.CLUSTER_NAME}}-cluster"
    cmds:
      - task: :_core:message
        vars: { MESSAGE: Updating Helm repositories... }
      - helm repo update 1>/dev/null
      - task: :_core:message
        vars: { MESSAGE: Generating Cilium manifest using Helm template... }
      - |
        helm template \
            cilium \
            cilium/cilium \
            --version {{ .CILIUM_VERSION }} \
            --namespace kube-system \
            --set ipam.mode=kubernetes \
            --set kubeProxyReplacement=strict \
            --set securityContext.capabilities.ciliumAgent="{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}" \
            --set securityContext.capabilities.cleanCiliumState="{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}" \
            --set cgroup.autoMount.enabled=false \
            --set cgroup.hostRoot=/sys/fs/cgroup \
            --set k8sServiceHost="control-plane.{{ .CLUSTER_DOMAIN }}" \
            --set k8sServicePort="{{ .CLUSTER_API_SERVER_PORT }}" > {{ .CLUSTER_DIR }}/cilium.yaml \
            --set bgpControlPlane.enabled=true \
            --set ingressController.enabled=true \
            --set ingressController.loadbalancerMode=shared \
            --set hubble.relay.enabled=true \
            --set hubble.ui.enabled=true \
            --set hubble.peerService.clusterDomain="{{ .CLUSTER_DOMAIN }}" \
            --set tunnelPort=6669
      - task: :_core:message
        vars: { MESSAGE: Applying Cilium manifest to .CLUSTER_NAME cluster... }
      - kubectl apply -f {{ .CLUSTER_DIR }}/cilium.yaml 1>/dev/null
      - task: :_core:message
        vars: { MESSAGE: Cilium manifest applied to .CLUSTER_NAME cluster }
