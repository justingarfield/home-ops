---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

vars:
  TALOS_SRC_DIR: '{{.REPOSITORY_DIR}}/talos-linux'
  TALOS_OUT_DIR: '{{.ENV_OUTPUT_DIR}}/talos-linux'

tasks:

  ### Secrets Bundle / PKI related
  generate-secrets-bundle-from-pki:
    desc: Generate a secrets bundle for a Talos environment using a pre-generated Single Root Intermediary CA directory
    vars:
      K8S_PKI_DIR: '{{.K8S_PKI_DIR}}'
      _BOOTSTRAP_TOKEN:
        sh: kubeadm token generate
      _OUTPUT_FILENAME: '{{.TALOS_OUT_DIR}}/secrets-bundle.yaml'
    preconditions:
      - sh: which talosctl
        msg: The 'talosctl' binary is required on the path to run this task'
      - sh: which kubeadm
        msg: The 'kubeadm' binary is required on the path to run this task'
      - sh: test '{{._BOOTSTRAP_TOKEN}}'
        msg: Issues using kubeadm to generate a bootstrap token _BOOTSTRAP_TOKEN
      - sh: test '{{.K8S_PKI_DIR}}'
        msg: Please provide a valid K8S_PKI_DIR
      - sh: test -d {{.K8S_PKI_DIR}}
        msg: Please provide a valid K8S_PKI_DIR ({{.K8S_PKI_DIR}} does not exist)
    cmds:
      - task: :_core:ensure-directory-exists2
        vars: { DIRECTORY: '{{._OUTPUT_FILENAME | dir}}' }
      - task: :_core:message
        vars: { MESSAGE: Generating secrets-bundle.yaml file... }
      - |
        talosctl gen secrets \
          --talos-version v1.5.1 \
          --from-kubernetes-pki "{{.K8S_PKI_DIR}}" \
          --kubernetes-bootstrap-token {{._BOOTSTRAP_TOKEN}} \
          --output-file "{{._OUTPUT_FILENAME}}" >/dev/null 2>&1
      - task: :_core:message
        vars: { MESSAGE: secrets-bundle.yaml file generated }
    sources:
      - '{{.K8S_PKI_DIR}}'
      - '{{._BOOTSTRAP_TOKEN}}'
    generates:
      - '{{._OUTPUT_FILENAME}}'

  ### Boot Assets related
  build-custom-iso:
    desc: Builds Talos ISO Boot Asset w/ Intel ucode and DRBD extensions
    cmds:
      - |
        docker run --rm -t --privileged -v $PWD/_out:/out ghcr.io/siderolabs/imager:v1.5.1 iso \
          --system-extension-image ghcr.io/siderolabs/intel-ucode:20230808 \
          --system-extension-image ghcr.io/siderolabs/drbd:9.2.4-v1.5.1

  build-custom-metal:
    desc: Builds Talos Metal Boot Asset w/ Intel ucode and DRBD extensions
    cmds:
      - |
        docker run --rm -t --privileged -v /dev:/dev -v $PWD/_out:/out ghcr.io/siderolabs/imager:v1.5.1 metal \
          --system-extension-image ghcr.io/siderolabs/intel-ucode:20230808 \
          --system-extension-image ghcr.io/siderolabs/drbd:9.2.4-v1.5.1

  build-custom-installer:
    desc: Builds Talos Installer Boot Asset w/ Intel ucode and DRBD extensions
    cmds:
      - |
        docker run --rm -t --privileged -v $PWD/_out:/out ghcr.io/siderolabs/imager:v1.5.1 installer \
          --system-extension-image ghcr.io/siderolabs/intel-ucode:20230808@sha256:696741417a09e06ccd571bb8a716877742c0537b1d777412234702243b82de7c \
          --system-extension-image ghcr.io/siderolabs/drbd:9.2.4-v1.5.1@sha256:8a5b543ef38c27e1055ee68881fca1936455f3e897ec9d4685e86bf82507a562

  ### Machine Config related
  generate-talos-configs:
    desc: Generate machine configs for a particular cluster
    vars:
      CLUSTER_NAME: '{{.CLUSTER_NAME | default .ENVIRONMENT_NAME | lower}}'
      CONTROL_PLANE_HOSTNAME: '{{.CONTROL_PLANE_HOSTNAME | default "control-plane"}}'
      CLUSTER_API_SERVER_PORT: '{{.CLUSTER_API_SERVER_PORT | default "6443"}}'
      SECRETS_BUNDLE_FILENAME: '{{.TALOS_OUT_DIR}}/secrets-bundle.yaml'
      CLUSTER_LOAD_BALANCER_IP: '{{.CLUSTER_LOAD_BALANCER_IP}}'
    preconditions:
      - sh: which talosctl
        msg: The 'talosctl' binary is required on the path to run this task'
      - test {{.CLUSTER_NAME}}
      - test {{.CONTROL_PLANE_HOSTNAME}}
      - test {{.CLUSTER_API_SERVER_PORT}}
      - test {{.SECRETS_BUNDLE_FILENAME}}
      - test -f '{{.SECRETS_BUNDLE_FILENAME}}'
      - test {{.CLUSTER_LOAD_BALANCER_IP}}
    cmds:
      - task: :_core:ensure-directory-exists2
        vars: { DIRECTORY: '{{.TALOS_OUT_DIR}}' }
      - task: :_core:message
        vars: { MESSAGE: Generating machine-config related files... }
      - |
        talosctl gen config {{.CLUSTER_NAME}} https://{{.CONTROL_PLANE_HOSTNAME}}.{{.INTERNAL_DOMAIN}}:{{.CLUSTER_API_SERVER_PORT}} \
          --with-secrets {{.SECRETS_BUNDLE_FILENAME}} \
          --additional-sans {{.CLUSTER_LOAD_BALANCER_IP}} \
          --install-image ghcr.io/siderolabs/installer:v1.5.1 \
          --kubernetes-version 1.28.0 \
          --talos-version v1.5.1 \
          --version v1alpha1 \
          --with-cluster-discovery=false \
          --with-docs=false \
          --with-examples=false \
          --config-patch-control-plane @{{.TALOS_SRC_DIR}}/cilium-opnsense-bgp-peering-policy.patch \
          --config-patch-control-plane @{{.TALOS_SRC_DIR}}/disable-cni-and-kube-proxy.patch \
          --config-patch-worker @{{.TALOS_SRC_DIR}}/kubelet-unsafe-sysctls.patch \
          --config-patch @{{.TALOS_SRC_DIR}}/machine-cert-sans.patch \
          --config-patch @{{.TALOS_SRC_DIR}}/registry-mirrors.patch \
          --config-patch @{{.TALOS_SRC_DIR}}/system-disk-encryption.patch \
          --config-patch='[{"op": "replace", "path": "/machine/systemDiskEncryption/ephemeral/keys", "value": [{ "static": { "passphrase": "{{.EPHEMERAL_PASSPHRASE}}" }, "slot": 0 }] }]' \
          --output {{.TALOS_OUT_DIR}}
      - task: :_core:message
        vars: { MESSAGE: machine-config related files generated }

  merge-config-files:
    desc: Sets up the talos and kubectl configuration files
    cmds:
      - task: :_core:message
        vars: { MESSAGE: Merging in talosconfig and setting endpoints... }
      - talosctl config merge "{{.TALOS_OUT_DIR}}/talosconfig" >/dev/null 2>&1
      - talosctl config endpoints talos-endpoints.{{.INTERNAL_DOMAIN}}
      - task: :_core:message
        vars: { MESSAGE: talosconfig and endpoints updated }

  apply-machine-template:
    internal: true
    desc: Apply a machine-template to a particular cluster node
    vars:
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      NODE_NAME: "{{.NODE_NAME}}"
      NODE_TYPE: "{{.NODE_TYPE}}"
      CLUSTER_DIR: "{{.TALOS_SRC_DIR}}/{{.CLUSTER_NAME}}-cluster"
    preconditions:
      - sh: which talosctl
        msg: The 'talosctl' binary is required on the path to run this task'
    cmds:
      - ./scripts/talos/wait-for-talos-boot.sh {{.NODE_NAME}}.{{.INTERNAL_DOMAIN}}
      - task: :_core:message
        vars: { MESSAGE: "Applying Talos machine-template to {{.NODE_TYPE}} node {{.NODE_NAME}}" }
      - talosctl apply-config --insecure --nodes {{.NODE_NAME}}.{{.INTERNAL_DOMAIN}} --file {{.TALOS_OUT_DIR}}/{{.NODE_TYPE}}.yaml
      - task: :_core:message
        vars: { MESSAGE: "Applied Talos machine-template to {{.NODE_TYPE}} node {{.NODE_NAME}}" }

  bootstrap-etcd:
    internal: false
    desc: Bootstraps etcd on a particular cluster's '-cp01' node
    vars:
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
    preconditions:
      - sh: which talosctl
        msg: The 'talosctl' binary is required on the path to run this task'
    cmds:
      - ./scripts/talos/wait-for-etcd-ready.sh k8s-cp01.{{.INTERNAL_DOMAIN}}
      - task: :_core:message
        vars: { MESSAGE: Issuing etcd bootstrap command... }
      - talosctl bootstrap --nodes k8s-cp01.{{.INTERNAL_DOMAIN}}
      - task: :_core:message
        vars: { MESSAGE: etcd bootstrap process has started }

  ### Maintenance related
  etcd-db-snapshot:
    desc: Take a reguarly scheduled etcd database backup
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} etcd snapshot db.snapshot

  ### Tasks below here are disaster recovery related
  etcd-db-direct-copy:
    desc: Only use as a last-resort to get a snapshot (aka your cluster is beyond f**ked)
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} cp /var/lib/etcd/member/snap/db .

  get-machine-configuration-raw:
    desc:
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} get mc v1alpha1 -o yaml | yq eval '.spec' -

  query-machine-etcd-state:
    desc:
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} etcd members
      - talosctl -n {{.IP_ADDRESS}} service etcd
      - talosctl -n {{.IP_ADDRESS}} get machinetype

  wipe-epehmeral-partition:
    desc:
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} reset --graceful=false --reboot --system-labels-to-wipe=EPHEMERAL

  bootstrap-with-etcd-backup:
    desc:
    vars:
      IP_ADDRESS: '{{.IP_ADDRESS}}'
    cmds:
      - talosctl -n {{.IP_ADDRESS}} bootstrap --recover-from=./db.snapshot
