---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &helmReleaseName authelia
  namespace: authelia
spec:
  chart:
    spec:
      # renovate: registryUrl=https://charts.authelia.com
      chart: authelia
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
      version: 0.8.57
  install:
    crds: Skip
    remediation:
      # I set this to larger value than upgrade section, as resource
      # contention may be a little wonky after a fresh cluster boot.
      retries: 5
  interval: 30m
  maxHistory: 3
  releaseName: *helmReleaseName
  upgrade:
    crds: Skip
    remediation:
      retries: 3
  test:
    enable: true
    ignoreFailures: false
  values:
    # rbac:
    #  enabled: true
    domain: ${PUBLIC_DNS_ZONE}
    # ingress:
    #   enabled: true
    #   className: cilium
    #   annotations:
    #     cert-manager.io/cluster-issuer: letsencrypt
    #   tls:
    #    enabled: true
    #    secret: tls-authelia
    configMap:
      access_control:
        rules:
          - domain: "*.${PUBLIC_DNS_ZONE}"
            policy: one_factor
      authentication_backend:
        ldap:
          enabled: false
        file:
          enabled: true
      notifier:
        filesystem:
          enabled: true
          filename: /config/notification.txt
        smtp:
          enabled: false
      session:
        redis:
          enabled: false
      storage:
        local:
          enabled: true
          path: /config/db.sqlite3
        postgres:
          enabled: false
