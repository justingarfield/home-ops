---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &helmReleaseName authelia
  namespace: authelia
spec:
  chart:
    spec:
      # renovate: registryUrl=https://charts.authelia.com
      chart: authelia
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
      version: 0.8.57
  install:
    crds: Skip
    remediation:
      # I set this to larger value than upgrade section, as resource
      # contention may be a little wonky after a fresh cluster boot.
      retries: 5
  interval: 30m
  maxHistory: 3
  releaseName: *helmReleaseName
  upgrade:
    crds: Skip
    remediation:
      retries: 3
  test:
    enable: true
    ignoreFailures: false
  values:
    configMap:
      enabled: false
    domain: "${PUBLIC_DNS_ZONE}"
    enableServiceLinks: "false"
    env:
      AUTHELIA_THEME: "dark"
      AUTHELIA_DEFAULT_REDIRECTION_URL: "https://auth.${PUBLIC_DOMAIN}"
      AUTHELIA_DEFAULT_2FA_METHOD: "totp"
      AUTHELIA_LOG_LEVEL: "info"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_URL: "ldap://lldap.lldap.svc.${CLUSTER_DOMAIN}:389"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_ADDITIONAL_USERS_DN: "ou=people"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USERS_FILTER: "(&({username_attribute}={input})(objectClass=person))"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_ADDITIONAL_GROUPS_DN: "ou=groups"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_GROUPS_FILTER: "(member={dn})"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_GROUP_NAME_ATTRIBUTE: "cn"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USERNAME_ATTRIBUTE: "uid"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_MAIL_ATTRIBUTE: "mail"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_DISPLAY_NAME_ATTRIBUTE: "displayName"
      AUTHELIA_SESSION_DOMAIN: "${PUBLIC_DOMAIN}"
      AUTHELIA_TOTP_ISSUER: "${PUBLIC_DOMAIN}"
      AUTHELIA_DUO_API_DISABLE: "true"
      AUTHELIA_NTP_ADDRESS: "${NTP_SERVER_IP}"
      AUTHELIA_STORAGE_LOCAL_PATH: "/config/db.sqlite3"
      AUTHELIA_NOTIFIER_SMTP_PORT: "587"
      AUTHELIA_NOTIFIER_SMTP_SENDER: "Authelia <authelia@${PUBLIC_DOMAIN}>"
      # AUTHELIA_SERVER_PORT: &port 9091
      AUTHELIA_WEBAUTHN_DISABLE: "true"
      AUTHELIA_PASSWORD_POLICY_ZXCVBN_ENABLED: "true"
    envFrom:
      - secretRef:
          name: "authelia"
    ingress:
      enabled: true
      className: cilium
    persistence:
      config:
        enabled: true
        type: configMap
        name: authelia-configmap
        subPath: configuration.yaml
        mountPath: /configuration.yaml
        readOnly: false
    rbac:
      enabled: "true"
